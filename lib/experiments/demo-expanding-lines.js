// Generated by CoffeeScript 2.4.1
(function() {
  'use strict';
  var $, $async, $watch, CND, FS, ICE, MIRAGE, PATH, PD, abspath, assign, badge, debug, declare, do_validate, echo, first, help, info, isa, jr, last, relpath, rpr, select, size_of, stamp, testing, type_of, types, urge, validate, warn, whisper;

  //###########################################################################################################
  CND = require('cnd');

  rpr = CND.rpr;

  badge = 'MKTS-MIRAGE/EXPERIMENTS/EXPANDING-LINES';

  debug = CND.get_logger('debug', badge);

  warn = CND.get_logger('warn', badge);

  info = CND.get_logger('info', badge);

  urge = CND.get_logger('urge', badge);

  help = CND.get_logger('help', badge);

  whisper = CND.get_logger('whisper', badge);

  echo = CND.echo.bind(CND);

  //...........................................................................................................
  FS = require('fs');

  PATH = require('path');

  PD = require('pipedreams');

  ({$, $watch, $async, select, stamp} = PD);

  ({assign, jr} = CND);

  first = Symbol('first');

  last = Symbol('last');

  types = require('../types');

  //...........................................................................................................
  ({isa, validate, declare, size_of, type_of} = types);

  //...........................................................................................................
  ({assign, abspath, relpath} = require('../helpers'));

  //...........................................................................................................
  require('../exception-handler');

  ICE = require('icepick');

  MIRAGE = require('../..');

  do_validate = true;

  //-----------------------------------------------------------------------------------------------------------
  this.new_datom = function(...P) {
    var R, ref, ref1;
    R = PD.new_event(...P);
    if (((!((ref = R.value) != null ? ref.vlnr_txt : void 0)) != null) && (((ref1 = R.value) != null ? ref1.vlnr : void 0) != null)) {
      R.value.vlnr_txt = jr(R.value.vlnr);
    }
    R.fresh = true;
    return ICE.freeze(R);
  };

  //-----------------------------------------------------------------------------------------------------------
  this.stamp = function(d) {
    var R;
    R = ICE.thaw(d);
    R.stamped = true;
    R.dirty = true;
    return ICE.freeze(R);
  };

  //-----------------------------------------------------------------------------------------------------------
  this.new_vlnr_level = function(S, vlnr) {
    var R;
    /* Given a `mirage` instance and a vectorial line number `vlnr`, return a copy of `vlnr`, call it
    `vlnr0`, which has an index of `0` appended, thus representing the pre-first `vlnr` for a level of lines
    derived from the one that the original `vlnr` pointed to. */
    validate.nonempty_list(vlnr);
    R = assign([], vlnr);
    R.push(0);
    return R;
  };

  //-----------------------------------------------------------------------------------------------------------
  this.advance_vlnr = function(S, vlnr) {
    var R;
    /* Given a `mirage` instance and a vectorial line number `vlnr`, return a copy of `vlnr`, call it
    `vlnr0`, which has its last index incremented by `1`, thus representing the vectorial line number of the
    next line in the same level that is derived from the same line as its predecessor. */
    validate.nonempty_list(vlnr);
    R = assign([], vlnr);
    R[vlnr.length - 1] += +1;
    return R;
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$split_words = function(S) {
    return $((d, send) => {
      var i, len, nxt_vlnr, prv_vlnr, ref, text, word;
      if (!select(d, '^mktscript')) {
        return send(d);
      }
      //.........................................................................................................
      send(this.stamp(d));
      text = d.value.text;
      prv_vlnr = d.value.vlnr;
      nxt_vlnr = this.new_vlnr_level(S, prv_vlnr);
      ref = text.split(/\s+/);
      //.........................................................................................................
      // unless isa.blank_text row.value
      for (i = 0, len = ref.length; i < len; i++) {
        word = ref[i];
        if (word === '') {
          continue;
        }
        nxt_vlnr = this.advance_vlnr(S, nxt_vlnr);
        send(this.new_datom('^word', {
          text: word,
          vlnr: nxt_vlnr
        }));
      }
      //.........................................................................................................
      return null;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.datom_from_row = function(S, row) {
    /* TAINT how to convert vlnr in ICQL? */
    var vlnr, vlnr_txt;
    vlnr_txt = row.vlnr_txt;
    vlnr = JSON.parse(vlnr_txt);
    return ICE.freeze(PD.new_event(row.key, {
      text: row.value,
      vlnr,
      vlnr_txt
    }));
  };

  //-----------------------------------------------------------------------------------------------------------
  this.row_from_datom = function(S, d) {
    /* TAINT how to convert booleans in ICQL? */
    var R, ref, stamped, v;
    v = d.value;
    stamped = (ref = d.stamped) != null ? ref : false;
    stamped = stamped ? 1 : 0;
    R = ICE.freeze({
      key: d.key,
      vlnr_txt: v.vlnr_txt,
      value: v.text,
      stamped
    });
    if (do_validate) {
      validate.mirage_main_row(R);
    }
    return R;
  };

  //-----------------------------------------------------------------------------------------------------------
  this.feed_source = function(S, source, limit = 2e308) {
    var dbr, nr, ref, row;
    dbr = S.mirage.db;
    nr = 0;
    ref = dbr.read_unstamped_lines();
    //.........................................................................................................
    for (row of ref) {
      nr += +1;
      if (nr > limit) {
        break;
      }
      source.send(this.datom_from_row(S, row));
    }
    //.........................................................................................................
    source.end();
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this.$feed_db = function(S) {
    /* TAINT stopgap measure; should be implemented in ICQL */
    var db2;
    db2 = (MIRAGE.new_settings(S.mirage)).db;
    return $watch((d) => {
      /* TAINT how to convert vlnr in ICQL? */
      var error, row;
      row = this.row_from_datom(S, d);
      try {
        /* TAINT consider to use upsert instead https://www.sqlite.org/lang_UPSERT.html */
        if (d.fresh) {
          db2.insert(row);
        } else if (d.dirty) {
          db2.update(row);
        }
      } catch (error1) {
        error = error1;
        warn(`µ12133 when trying to insert or update row ${jr(row)}`);
        warn("µ12133 an error occurred:");
        warn(`µ12133 ${error.message}`);
        throw error;
      }
      return null;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this._$show = function(S) {
    return $watch((d) => {
      var color;
      if (d.stamped) {
        color = CND.grey;
      } else {
        switch (d.key) {
          case '^word':
            color = CND.gold;
            break;
          default:
            color = CND.white;
        }
      }
      return info(color(jr(d)));
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this._$on_finish = function(S) {
    var dbr;
    dbr = S.mirage.db;
    //.........................................................................................................
    return $watch({last}, (d) => {
      var color, key, ref, ref1, row, vlnr;
      if (d !== last) {
        return null;
      }
      ref = dbr.read_lines();
      //.......................................................................................................
      for (row of ref) {
        color = row.stamped ? CND.grey : CND.green;
        key = row.key.padEnd(12);
        vlnr = row.vlnr_txt.padEnd(12);
        info(color(`${vlnr} ${(row.stamped ? 'S' : ' ')} ${key} ${rpr(row.value.slice(0, 41))}`));
      }
      ref1 = dbr.get_stats();
      //.......................................................................................................
      for (row of ref1) {
        info(`${row.key}: ${row.count}`);
      }
      //.......................................................................................................
      return null;
    });
  };

  //-----------------------------------------------------------------------------------------------------------
  this.translate_document = function(me) {
    return new Promise((resolve, reject) => {
      var S, limit, pipeline, source;
      /* TAINT add suitable types */
      validate.object(me);
      S = {
        mirage: me
      };
      source = PD.new_push_source();
      limit = 2e308;
      //.........................................................................................................
      pipeline = [];
      pipeline.push(source);
      pipeline.push(this.$split_words(S));
      pipeline.push(this.$feed_db(S));
      // pipeline.push PD.$show()
      // pipeline.push @_$show()
      pipeline.push(this._$on_finish(S));
      pipeline.push(PD.$drain(() => {
        return resolve();
      }));
      //.........................................................................................................
      PD.pull(...pipeline);
      this.feed_source(S, source, limit);
      return null;
    });
  };

  //###########################################################################################################
  if (module.parent == null) {
    testing = true;
    (async() => {
      var mirage;
      //.......................................................................................................
      mirage = MIRAGE.new_settings('../README.md');
      await MIRAGE.acquire(mirage);
      await this.translate_document(mirage);
      return help('ok');
    })();
  }

}).call(this);

//# sourceMappingURL=demo-expanding-lines.js.map
