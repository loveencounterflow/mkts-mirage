{
  "version": 3,
  "file": "db.js",
  "sourceRoot": "..",
  "sources": [
    "src/db.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n\n'use strict'\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'MKTS-MIRAGE/DB'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\n#...........................................................................................................\nPATH                      = require 'path'\n# FS                        = require 'fs'\nPD                        = require 'pipedreams'\n{ $\n  $async\n  select }                = PD\n{ assign\n  jr }                    = CND\n#...........................................................................................................\njoin_path                 = ( P... ) -> PATH.resolve PATH.join P...\nboolean_as_int            = ( x ) -> if x then 1 else 0\n{ inspect, }              = require 'util'\nxrpr                      = ( x ) -> inspect x, { colors: yes, breakLength: Infinity, maxArrayLength: Infinity, depth: Infinity, }\nxrpr2                     = ( x ) -> inspect x, { colors: yes, breakLength: 80,       maxArrayLength: Infinity, depth: Infinity, }\n#...........................................................................................................\nICQL                      = require 'icql'\n# INTERTYPE                 = require './types'\n{ assign\n  abspath }               = require './helpers'\n\n#-----------------------------------------------------------------------------------------------------------\n@get_icql_settings = ( db_path = null ) ->\n  ### TAINT path within node_modules might differ ###\n  ### TAINT extensions should conceivably be configured in `*.icql` file or similar ###\n  # R.db_path   = join_path __dirname, '../../db/data.db'\n  R                 = {}\n  R.connector       = require 'better-sqlite3'\n  R.db_path         = db_path ? abspath './db/mkts.db'\n  R.icql_path       = abspath './db/mkts.icql'\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@new_db = ( settings ) ->\n  db                    = ICQL.bind @get_icql_settings ( settings?.db_path ? null )\n  clear_db              = settings?.clear ? false\n  @load_extensions      db\n  @set_pragmas          db\n  #.........................................................................................................\n  if clear_db\n    clear_count = db.$.clear()\n    info \"deleted #{clear_count} objects\"\n  #.........................................................................................................\n  @create_db_functions  db\n  #.........................................................................................................\n  return db\n\n#-----------------------------------------------------------------------------------------------------------\n@set_pragmas = ( db ) ->\n  db.$.pragma 'foreign_keys = on'\n  db.$.pragma 'synchronous = off' ### see https://sqlite.org/pragma.html#pragma_synchronous ###\n  db.$.pragma 'journal_mode = WAL' ### see https://github.com/JoshuaWise/better-sqlite3/issues/125 ###\n  #.........................................................................................................\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@load_extensions = ( db ) ->\n  warn \"skipping sqlite extensions\"\n  return null\n  extensions_path = abspath './sqlite-for-mingkwai-ime/extensions'\n  debug 'µ39982', \"extensions_path\", extensions_path\n  db.$.load join_path extensions_path, 'spellfix.so'\n  db.$.load join_path extensions_path, 'csv.so'\n  db.$.load join_path extensions_path, 'regexp.so'\n  db.$.load join_path extensions_path, 'series.so'\n  db.$.load join_path extensions_path, 'nextchar.so'\n  # db.$.load join_path extensions_path, 'stmt.so'\n  #.........................................................................................................\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@create_db_functions = ( db ) ->\n  # db.$.function 'add_spellfix_confusable', ( a, b ) ->\n  # db.$.function 'spellfix1_phonehash', ( x ) ->\n  #   debug '23363', x\n  #   return x.toUpperCase()\n\n  #---------------------------------------------------------------------------------------------------------\n  db.$.function 'echo', { deterministic: false, varargs: true }, ( P... ) ->\n    ### Output text to command line. ###\n    ### TAINT consider to use logging method to output to app console. ###\n    urge ( CND.grey 'DB' ), P...\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  db.$.function 'e', { deterministic: false, varargs: false }, ( x ) ->\n    ### Output text to command line, but returns single input value so can be used within an expression. ###\n    urge ( CND.grey 'DB' ), rpr x\n    return x\n\n  #---------------------------------------------------------------------------------------------------------\n  db.$.function 'e', { deterministic: false, varargs: false }, ( mark, x ) ->\n    ### Output text to command line, but returns single input value so can be used within an expression. ###\n    urge ( CND.grey \"DB #{mark}\" ), rpr x\n    return x\n\n  #---------------------------------------------------------------------------------------------------------\n  db.$.function 'contains_word', { deterministic: true, varargs: false }, ( text, probe ) ->\n    return if ( ( ' ' + text + ' ' ).indexOf ' ' + probe + ' ' ) > -1 then 1 else 0\n\n  #---------------------------------------------------------------------------------------------------------\n  db.$.function 'get_words', { deterministic: true, varargs: false }, ( text ) ->\n    ### Given a text, return a JSON array with words (whitespace-separated non-empty substrings). ###\n    JSON.stringify ( word for word in text.split /\\s+/ when word isnt '' )\n\n  # #---------------------------------------------------------------------------------------------------------\n  # db.$.function 'vnr_encode_textual', { deterministic: true, varargs: false }, ( vnr ) ->\n  #   ( ( \"#{idx}\".padStart 6, '0' ) for idx in ( JSON.parse vnr ) ).join '-'\n\n  #---------------------------------------------------------------------------------------------------------\n  db.$.function 'vnr_encode', { deterministic: true, varargs: false }, ( vnr ) ->\n    try\n      Uint32Array.from JSON.parse vnr\n    catch error\n      warn \"µ33211 when trying to convert #{xrpr2 vnr}\"\n      warn \"µ33211 to a typed array, an error occurred:\"\n      warn \"µ33211 #{error.message}\"\n      throw error\n\n  # #---------------------------------------------------------------------------------------------------------\n  # db.$.function 'get_nth_word', { deterministic: true, varargs: false }, ( text, nr ) ->\n  #   ### NB SQLite has no string aggregation, no string splitting, and in general does not implement\n  #   table-returning user-defined functions (except in C, see the `prefixes` extension). Also, you can't\n  #   modify tables from within a UDF because the connection is of course busy executing the UDF.\n  #   As a consequence, it is well-nigh impossible to split strings to rows in a decent manner. You could\n  #   probably write a 12-liner with a recursive CTE each time you want to split a string. Unnecessary to\n  #   mention that SQLite does not support putting *that* thing into a UDF (because those can't return\n  #   anything except a single atomic value).\n\n  #   **Update** Turns out the `json1` extension can help out; see the `get_words()` UDF. ###\n  #   ### TAINT to be deprecated in favor of `get_words()` ###\n  #   parts = text.split /\\s+/\n  #   return parts[ nr - 1 ] ? null\n\n  #---------------------------------------------------------------------------------------------------------\n  return null\n\n\n\n\n\n\n\n"
  ]
}