{
  "version": 3,
  "file": "main.js",
  "sourceRoot": "..",
  "sources": [
    "src/main.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n\n'use strict'\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'MKTS-MIRAGE/MAIN'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\n#...........................................................................................................\nFS                        = require 'fs'\nPATH                      = require 'path'\nPD                        = require 'pipedreams'\n{ $\n  $async\n  select }                = PD\n{ assign\n  jr }                    = CND\n@_drop_extension          = ( path ) -> path[ ... path.length - ( PATH.extname path ).length ]\ntypes                     = require './types'\n#...........................................................................................................\n{ isa\n  validate\n  declare\n  size_of\n  last_of\n  type_of }               = types\n#...........................................................................................................\n{ assign\n  abspath\n  relpath }               = require './helpers'\n#...........................................................................................................\nrequire                   './exception-handler'\nTMP                       = require 'tmp-promise'\n\n\n#-----------------------------------------------------------------------------------------------------------\nas_sql = ( x ) ->\n  validate.text x\n  R = x\n  R = R.replace /'/g, \"''\"\n  return \"'#{R}'\"\n\n#-----------------------------------------------------------------------------------------------------------\n@$as_sql = =>\n  first           = Symbol 'first'\n  last            = Symbol 'last'\n  is_first_record = true\n  lnr             = 0\n  return $ { first, last, }, ( line, send ) =>\n    #.......................................................................................................\n    ### TAINT consider to store SQL as `fragment`s in `mkts.icql` ###\n    if line is first\n      send \"drop table if exists main;\"\n      send \"create table main ( \"\n      send \"    vnr_txt   json,\"\n      # send \"    vnr_txt  json unique,\"\n      send \"    stamped   boolean default false,\"\n      send \"    key       text default '^mktscript',\"\n      send \"    value     text );\"\n      send \"insert into main ( vnr_txt, value ) values\"\n    #.......................................................................................................\n    else if line is last\n      send \";\"\n      # send \"create unique index idx_main_lnr on main ( lnr );\"\n    #.......................................................................................................\n    else\n      lnr  += +1\n      comma = if is_first_record then '' else ','\n      is_first_record = false\n      send \"\"\"#{comma}( '[#{lnr}]', #{as_sql line} )\"\"\"\n  #.........................................................................................................\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@_$tee_without_filter = ( bystream ) ->\n  ### Given a `bystream`, send a data down both the mainstream and the bystream. This allows e.g. to log all\n  events to a file sink while continuing to process the same data in the mainline. **NB** that in\n  contradistinction to `pull-tee`, you can only divert to a single by-stream with each call to `PS.$tee` ###\n  return ( require 'pull-tee' ) bystream\n\n#-----------------------------------------------------------------------------------------------------------\n@$tee_compile_sql = ( target_path_sql, handler ) =>\n  collector = []\n  pipeline  = []\n  pipeline.push @$as_sql()\n  # pipeline.push @$as_line()\n  pipeline.push PD.$collect { collector, }\n  pipeline.push PD.$drain -> handler null, collector.join '\\n'\n  return PD.$tee PD.pull pipeline...\n\n#-----------------------------------------------------------------------------------------------------------\n@compile_sql = ( settings ) -> new Promise ( resolve, reject ) =>\n  validate.object settings\n  S = settings\n  help \"reading #{rpr S.rel_source_path}\"\n  #.........................................................................................................\n  pipeline = []\n  pipeline.push PD.read_from_file S.source_path\n  pipeline.push PD.$split()\n  pipeline.push @$tee_compile_sql S, ( error, sql ) =>\n    help \"wrote output to #{rpr S.target_path_sql}\"\n    resolve sql\n  pipeline.push PD.$drain()\n  PD.pull pipeline...\n  #.........................................................................................................\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n_$count = ( step ) ->\n  nr = 0\n  return PD.$watch ( d ) =>\n    nr += +1\n    if ( nr %% step ) is 0\n      whisper 'µ44744', nr\n    return null\n\n#-----------------------------------------------------------------------------------------------------------\n@populate_db = ( me, sql ) -> new Promise ( resolve, reject ) =>\n  validate.object me\n  me.db.$.execute sql\n  line_count = me.db.$.first_value me.db.count_lines()\n  info \"MKTS document #{rpr me.rel_source_path} has #{line_count} lines\"\n  resolve()\n\n#-----------------------------------------------------------------------------------------------------------\n@cleanup = ( settings ) -> new Promise ( resolve, reject ) =>\n  settings.remove_tmpfile()\n  resolve()\n\n#-----------------------------------------------------------------------------------------------------------\n@new_settings = ( settings ) ->\n  validate.true ( isa_text = isa.text settings ) or ( isa.object settings )\n  settings                = { source_path: settings, } if isa_text\n  R                       = {}\n  R.db                    = ( require './db' ).new_db { clear: false, }\n  R.testing               = settings.testing ? false\n  R.source_path           = settings.source_path\n  R.rel_source_path       = relpath R.source_path\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@acquire = ( me ) -> new Promise ( resolve, reject ) =>\n  sql = await @compile_sql me\n  await @populate_db me, sql\n  resolve()\n\n\n############################################################################################################\nunless module.parent?\n  MIRAGE  = @\n  do ->\n    #.......................................................................................................\n    mirage = MIRAGE.new_settings './README.md'\n    await MIRAGE.acquire mirage\n    delete mirage.db\n    debug 'µ69688', mirage\n    help 'ok'\n\n\n"
  ]
}