
-- ---------------------------------------------------------------------------------------------------------
fragment create_table_main_first( default_dest, default_key ):
  drop table if exists main;
  create table main (
    vnr       json    unique not null primary key,
    vnr_blob  blob    unique not null,
    stamped   boolean not null default false,
    dest      text    not null default $default_dest,
    key       text    not null default $default_key,
    text      text,
    p         json    default 'null' );
  insert into main ( vnr, vnr_blob, text ) values
fragment create_table_main_middle( vnr, text ):
  ( $vnr, json_as_hollerith( $vnr ), $text )

-- ---------------------------------------------------------------------------------------------------------
query read_lines( limit ):
  select
      *
    from main
    order by vnr_blob
    limit $limit;

-- ---------------------------------------------------------------------------------------------------------
query read_lines():
  select
      *
    from main
    order by vnr_blob;

-- ---------------------------------------------------------------------------------------------------------
query read_unstamped_lines():
  select
      *
    from main
    where not stamped
    order by vnr_blob;

-- ---------------------------------------------------------------------------------------------------------
query count_lines():
  select count(*) from main;

-- ---------------------------------------------------------------------------------------------------------
query get_stats():
  select null as key, null as count where false union all
    select 'all lines',     count(*) from main                    union all
    select 'active lines',  count(*) from main where not stamped  union all
    select 'stamped lines', count(*) from main where     stamped  union all
    select null, null where false;

-- ---------------------------------------------------------------------------------------------------------
procedure _insert( key, vnr, vnr_blob, dest, text, p, stamped ):
  insert into
    main    (  key,  vnr,  vnr_blob,  dest,  text,  p,  stamped )
    values  ( $key, $vnr, $vnr_blob, $dest, $text, $p, $stamped );

-- ---------------------------------------------------------------------------------------------------------
procedure _update( key, vnr, vnr_blob, dest, text, p, stamped ):
  update main
    set (  key,  vnr,  vnr_blob,  dest,   text,  p,  stamped ) =
        ( $key, $vnr, $vnr_blob, $dest,  $text, $p, $stamped )
    where vnr = $vnr;

-- ---------------------------------------------------------------------------------------------------------
procedure _update( vnr ):
  update main
    set (  vnr,  vnr_blob ) =
        ( $vnr, $vnr_blob )
    where vnr = $vnr;

-- ---------------------------------------------------------------------------------------------------------
procedure stamp_line( vnr ): update main set stamped = true where vnr = $vnr;

